[toc]  

## 为什么要有线程

>自从60年代提出进程概念以来，在操作系统中一直以进程作为独立运行的基本单位，知道80年代中期，人们又提出了更小的能独立运行的基本单位 —— 线程

- 例如

  编写一个mp3播放软件

  1. 从MP3音频文件中读取数据
  2. 对数据进行解压缩
  3. 把解压缩后的音频数据播放出来

- 单进程的实现方法

  ```
  main() {
  	while(TRUE) {
  		Read()
  		Decompress()
  		Play()
  	}
  }
  ```

  问题

  - 播放出来的声音能否连贯？
  - 各个函数之间不是并发进行，影响资源的使用效率

- 多进程的实现方法

  ```
  main() {
  	while(TRUE) {
  		Read()
  	}
  }
  ```

  ```
  main() {
  	while(TRUE) {
  		Decompress()
  	}
  }
  ```

  ```
  main() {
  	while(TRUE) {
  		Play()
  	}
  }
  ```

  问题

  - 进程之间如何通信，共享数据？
  - 维护进程的系统开销较大，创建进程时，分配资源，建立PCB，撤销进程时，回收资源，撤销PCB，进程切换时，保存当前进程的状态信息。

- 怎么来解决这些问题？

  需要提出一种新的实体，满足以下特性：

  1. 实体之间可以并发地执行
  2. 实体之间共享相同的地址空间

  **线程满足以上两个条件**

## 什么是线程

> 线程是进程当中的一条执行流程

- 从两个方面来重新理解进程
  1. 从资源组合的角度：进程把一组相关的资源组合起来，构成了一个资源平台，包括地址空间（代码段，数据段），打开的文件等各种资源
  2. 从运行的角度：代码在这个资源平台上的一条执行流程（线程）

## 线程的优点

1. 一个进程可以同时存在多个线程
2. 各个线程之间可以并发执行
3. 各个线程之间可以共享地址空间和文件资源

## 线程的缺点

1. 一个线程破坏了进程中的某个数据，其他线程也会出错

## 线程和进程的比较

- 进程是资源分配的单位，线程是CPU调度的单位
- 进程拥有一个完整的资源平台，而线程只独享必不可少的资源，如寄存器和栈
- 线程同样具有就绪、阻塞和执行三种基本状态，同样具有状态之间的转换关系
- 线程能减少并发时间和空间开销
  - 线程的创建时间比进程短
  - 线程的终止时间比进程短
  - 同一进程内的线程切换时间比进程短
  - 由于同一进程的各线程共享内存和文件资源，可直接进行不通过内核的通信

## 用户线程和内核线程的对应关系

 https://juejin.cn/post/6844903962504593421

> 用户线程：操作系统看不见的线程，由用户线程同级的线程库调度（线程库位于用户空间，操作系统对此无感知）
>
> 内核线程：操作系统看得见的线程

- 一内核线程对一用户线程
- 一内核线程对多用户线程
- 多内核线程对多用户线程

![](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fupload-images.jianshu.io%2Fupload_images%2F1706906-32166fcc992479e4.png&refer=http%3A%2F%2Fupload-images.jianshu.io&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1636643343&t=8f4eee927f0a99d3ed944eeb9736c7a7)

在用户空间实现的线程机制，它不依赖于操作系统的内核，由一组用户级的线程库函数来完成线程的管理，包括线程的创建、终止、同步和调度等。

在操作系统的角度，只能看到进程，看不到进程中的线程，因此**一个进程中有多个线程，同一时刻也只能有一个线程在执行（这些线程只能占用一个CPU核）**

## 用户线程的缺点

- 如果一个线程发起系统调用而阻塞，则整个进程在等待
- 当一个线程开启运行后，除非它主动地交出CPU使用权，否则它所在地进程当中的其他线程将无法执行
- 由于时间片分配给进程，故与其他进程比，在多线程执行时，每个线程得到的时间片少，执行会较慢